rule extract_unmapped:
    input:
        # step = preprocessing / preprocessing
        # name = preprocessed / preprocessed
        '{step}/{type}.r1.{name}.fq',
        '{step}/{type}.r2.{name}.fq',
        '{step}/{type}.se.{name}.fq',

        # step = assembly / assembly
        # loop = assembly_1 / assembly_1
        # type = MT / MGMT
        '{step}/{new_type}.megahit_{name}.{loop}/final.contigs.fa'
        # ext=['amb', 'bwt', 'pac', 'sa', 'ann']
        '{step}/{loop}/final.contigs.fa.{ext}'
    output:
        # type = MT / MGMT
        '{step}/{new_type}.R1.unmapped.fq',
        '{step}/{new_type}.R2.unmapped.fq',
        '{step}/{new_type}.SE.unmapped.fq'
    shell:
        """
        TMP_FILE=$(mktemp --tmpdir={TMPDIR} -t "alignment_XXXXXX.bam")
        BUFFER=$(mktemp --tmpdir={TMPDIR} -t "alignment_buffer_XXXXXX.bam")
        bwa mem -v 1 -t {THREADS} {input[3]} {input[0]} {input[1]} | samtools view -@ {THREADS} -bS - > $TMP_FILE
        samtools merge -@ {THREADS} -u - \
        <(samtools view -@ {THREADS} -u  -f 4 -F 264 $TMP_FILE) \
        <(samtools view -@ {THREADS} -u -f 8 -F 260 $TMP_FILE) \
        <(samtools view -@ {THREADS} -u -f 12 -F 256 $TMP_FILE) | \
        samtools view -@ {THREADS} -bF 0x800 -  | samtools sort -o -@ {THREADS} -m {MEMCORE}G -n - $BUFFER | \
        bamToFastq -i stdin -fq {output[0]} -fq2 {output[1]}
        bwa mem -v 1 -t {THREADS} {input[3]} {input[2]} | \
        samtools view -@ {THREADS} -bS - | samtools view -@ {THREADS} -uf 4 - | \
        bamToFastq -i stdin -fq {output[2]}
        rm -rf $BUFFER* $TMP_FILE
        """
