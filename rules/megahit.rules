rule megahit:
    # name = preprocessed   / unmapped
    input:
        '{step}/{type}.r1.{name}.fq',
        '{step}/{type}.r2.{name}.fq',
        '{step}/{type}.se.{name}.fq',
    # loop = assembly_1  / assembly_2
    output:
        '{step}/{type}.megahit_{name}.{loop}/final.contigs.fa'
    params:
        outdir='{step}/{type}.megahit_{name}.{loop}'
    shell:
        """
        echo "[x] Performing {wildcards.type} assembly step '{wildcards.loop}' using MEGAHIT"
        if [ -d "{params.outdir}" ]; then
            rm -rf {params.outdir}
        fi

        MAX_MEM="$(({MEMTOTAL} * 1000000000))"

        megahit -1 {input[0]} \
        -2 {input[1]} \
        -r {input[2]} \
        -o {params.outdir} \
        --k-min {config[idba_ud][mink]} \
        --k-max {config[idba_ud][maxk]} \
        --k-step {config[idba_ud][step]} \
        --no-bubble \
        -t {THREADS} --cpu-only \
        -m "${{MAX_MEM}}" \
        --mem-flag 1

        if [ -d "{params.outdir}" ]; then
            rm -rf {params.outdir}
        fi
        echo "Performing first hyrbid assembly step using MEGAHIT"

        MAX_MEM="$(({MEMTOTAL} * 1000000000))"

        megahit -1 {input[0]},{input[3]} \
        -2 {input[1]},{input[4]} \
        -r {input[2]},{input[5]},{input[6]},{input[7]} \
        -o {params.outdir} \
        --k-min {config[idba_ud][mink]} \
        --k-max {config[idba_ud][maxk]} \
        --k-step {config[idba_ud][step]} \
        -t {THREADS} --cpu-only \
        -m ${{MAX_MEM}} \
        --mem-flag 1 >> {log} 2>&1
        cp {output[0]} {output[1]}
        """
